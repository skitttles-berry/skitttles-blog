---
title: "Spring4Shell ì·¨ì•½ì  ì •ë¦¬ ë° POC (CVE-2022-22965)"
date: 2022-04-07
draft: false
description: "Spring4Shell ì·¨ì•½ì  ì •ë¦¬ ë° POC (CVE-2022-22965)"
tags: ["security", "java","spring"]
categories: ["security"]
---
![logo](featured.png)
 
 ì—¬ëŸ¬ ê¸€ì„ ì •ë¦¬í•˜ì—¬ ì˜®ê²¼ìŠµë‹ˆë‹¤ ğŸ˜€

# ğŸ˜¸01 Summary
ì¤‘êµ­ì˜ í•œ ë³´ì•ˆ ì „ë¬¸ê°€ê°€ ì˜¬ë¦° Spring Core í”„ë ˆì„ì›Œí¬ ì·¨ì•½ì  POC í™”ë©´ì´ ë°œë‹¨ì´ ë˜ì–´ ì—¬ëŸ¬ POCê°€ ì›¹ ìƒì— ì˜¬ë¼ì™”ìŠµë‹ˆë‹¤. í•´ë‹¹ ì·¨ì•½ì ì€ "Spring4Shell" ë˜ëŠ” "SpringShell"ë¡œ ë¶ˆë¦¬ë©° 2022ë…„ 03ì›” 31ì¼ Spring ê°œë°œìì— ì˜í•´ 'CVE-2022-22965' ì·¨ì•½ì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.

Spring4Shell ì·¨ì•½ì ì€ Spring Core í”„ë ˆì„ì›Œí¬ì—ì„œ íŠ¹ì • ì¡°ê±´ í•˜ì— Remote Code Executionì´ ê°€ëŠ¥í•œ ì·¨ì•½ì ì´ë©° Spring í”„ë ˆì„ì›Œí¬ê°€ ë§¤ê°œë³€ìˆ˜ë¥¼ ë°”ì¸ë”©í•˜ëŠ” ê³¼ì •ì—ì„œ 'class' ê°ì²´ê°€ ë…¸ì¶œë˜ì–´ ë°œìƒí•©ë‹ˆë‹¤. 
ê³µê²©ìëŠ” í•´ë‹¹ 'class' ê°ì²´ì˜ ìì‹ ê°ì²´ì¸ 'class.module.classLoader'ì— ì›¹ ë§¤ê°œë³€ìˆ˜ë¥¼ í†µí•´ ì ‘ê·¼í•  ìˆ˜ ìˆìœ¼ë©° ë¡œê¹… ê´€ë ¨ í´ë˜ìŠ¤(AccessLogValve)ë¥¼ ì´ìš©í•˜ì—¬ ì›¹ ì‰˜ ì½”ë“œë¥¼ ì—…ë¡œë“œí•œ í›„, ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> ì·¨ì•½ ì¡°ê±´
- Java 9 ì´ìƒ
- Apache Tomcat ì„œë²„
- Spring Framework ë²„ì „ 5.3.0 ~ 5.3.17, 5.2.0 ~ 5.2.19 ë° ì´ì „ ë²„ì „
- spring-webmvc ë˜ëŠ” spring-webflux ì¢…ì†ì„±
- WAR í˜•íƒœë¡œ íŒ¨í‚¤ì§•

ì‚¬ì‹¤, ë¹„êµë˜ëŠ” 'Log4Shell'ì— ë¹„í•´ ì·¨ì•½ ì¡°ê±´ì´ ê¹Œë‹¤ë¡­ì§€ë§Œ ì·¨ì•½ì  ê³µê²© ë°©ë²•ì´ ë§¤ìš° ì‰¬ìš°ë¯€ë¡œ ì—¬ê±´ì´ ëœë‹¤ë©´ íŒ¨ì¹˜ë¥¼ í•˜ëŠ” ê²ƒì´ ì¢‹ì„ ê²ƒìœ¼ë¡œ íŒë‹¨ë©ë‹ˆë‹¤.

# ğŸ˜½02 Concept
Spring4Shell ì·¨ì•½ì ì€ ë§¤ê°œë³€ìˆ˜ë¥¼ ë°”ì¸ë”© í•  ë•Œ ë°œìƒí•©ë‹ˆë‹¤. ê·¸ëŸ¬ë©´ Springì—ì„œì˜ ë§¤ê°œë³€ìˆ˜ ë°”ì¸ë”©ê³¼ ì ‘ê·¼ì´ ì–´ë–¤ í˜•íƒœë¡œ ì´ë¤„ì§€ë©° ì–´ë–¤ ê³¼ì •ì—ì„œ ì·¨ì•½ì ì´ ë„ì¶œë˜ëŠ”ì§€ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.
## 02-01 ë§¤ê°œë³€ìˆ˜ ë°”ì¸ë”© ë° ì ‘ê·¼
Spring Coreì—ì„œëŠ” _@RequestMapping_ Annotationì„ ì´ìš©í•´ ë§¤ê°œë³€ìˆ˜ë¥¼ ë°”ì¸ë”© ë° ì ‘ê·¼í•˜ëŠ” 2ê°€ì§€ ë°©ë²•ì´ ì¡´ì¬í•©ë‹ˆë‹¤.

#### 'í‚¤-ê°’' ìŒìœ¼ë¡œ êµ¬ì„±ëœ Mapì„ ì´ìš©
ì•„ë˜ ìº¡ì²˜ì™€ ê°™ì´ Mapì—ì„œ ë§¤ê°œë³€ìˆ˜ì— ì ‘ê·¼í•  ìˆ˜ ìˆìœ¼ë©° ë§¤ê°œë³€ìˆ˜ì˜ ê°’ì€ 'model.data'ë¼ëŠ” Model Objectì— ì €ì¥ë˜ì–´ ì‚¬ìš©ë©ë‹ˆë‹¤.
![mapping](2.png)

#### POJO(Plain Old Java Object)ë¥¼ ì´ìš©
POJO(Plain Old Java Object)ë¼ê³  ë¶ˆë¦¬ëŠ” ì¼ë°˜ ìë°” ê°ì²´ì˜ ì†ì„±ì— URLì„ í†µí•´ ì…ë ¥ëœ ë§¤ê°œë³€ìˆ˜ê°€ ë§¤í•‘ë˜ì–´ ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì•„ë˜ ìº¡ì²˜ì—ì„œ ë§¤ê°œë³€ìˆ˜ëŠ” 'Greeting.greeting' ê°ì²´ì˜ ì†ì„±ì— ë°”ì¸ë”©ë˜ë©°, ì‹¤ì œ ìš”ì²­ì´ ì˜¤ë©´ 'Greeting' íƒ€ì…ì˜ ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ê·¼í•˜ì—¬ ì†ì„±ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
![binding](3.png)

ì•„ë˜ì™€ ê°™ì´ getter, setterë¥¼ ì´ìš©í•´ ë§¤ê°œë³€ìˆ˜ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
![getter_setter](4.png)


## 02-02 ì·¨ì•½ì 
í•´ë‹¹ ì·¨ì•½ì ì€ íŠ¹ì • ìƒí™©ì—ì„œ **'class'** ë¼ëŠ” íŠ¹ìˆ˜í•œ ë³€ìˆ˜ê°€ ì‚¬ìš©ìì—ê²Œ ë…¸ì¶œë˜ì–´ **'classLoader'** ì— ì ‘ê·¼í•  ìˆ˜ ìˆì„ë•Œ ë°œìƒí•˜ë©° ìƒì„¸í•œ ì ˆì°¨ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

1. ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ ì´ìš©ìê°€ ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ” í˜ì´ì§€ì— ì ‘ê·¼í•©ë‹ˆë‹¤.
2. ì–´í”Œë¦¬ì¼€ì´ì…˜ì€ ìš”ì²­ ë§¤ê°œë³€ìˆ˜ë¥¼ POJOì— ë°”ì¸ë”©í•˜ê¸° ìœ„í•´ **"getCachedIntrospectionResults"** ë¼ëŠ” ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•œ í›„ ìºì‹œì˜ Object ì†ì„±ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. _(ì´ë•Œ POJOëŠ” @RequestBody annotationì´ ì ìš©ë˜ì–´ ìˆì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤.)_
3. ë°˜í™˜ëœ Objectì—ëŠ” 'class' ê°€ í¬í•¨ë˜ì–´ ìˆì–´ ì‚¬ìš©ìëŠ” 'class' ê°ì²´ë¥¼ ì›ê²©ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.
4. ì´ìš©ìëŠ” ìš”ì²­ íŒ¨í‚· ë§¤ê°œë³€ìˆ˜ì— 'class'ì˜ ìì‹ ê°ì²´ì¸ 'class.module.classLoader'ì™€ ë¡œê¹… ê´€ë ¨ í´ë˜ìŠ¤(AccessLogValve)ë¥¼ ì…ë ¥, ì „ì†¡í•˜ì—¬ ê°ì²´ë¥¼ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Spring Core í”„ë ˆì„ì›Œí¬ì—ì„œ í•„í„°ë§í•˜ëŠ” ê°ì²´ë¥¼ ìš°íšŒí•˜ì—¬ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

![vulnerable](5.png)

íŒ¨ì¹˜ ì „ì—ëŠ” 'class'ì˜ ìì‹ ê°ì²´ì— ëŒ€í•œ ì§ì ‘ ì ‘ê·¼ì„ í•„í„°ë§í•˜ê¸° ìœ„í•´ **'CachedIntrospectionResults.java'** ì—ì„œ ì•„ë˜ì™€ ê°™ì´ **'class.classLoader'** ë° **'class.protectionDomain'** ì„ í•„í„°ë§ì„ í•˜ì˜€ì—ˆì§€ë§Œ **'class.module.classLoader'** ì„ ì‚¬ìš©í•˜ì—¬ ìš°íšŒ ê°€ëŠ¥í•˜ì˜€ìŠµë‹ˆë‹¤.
```java
if (Class.class == beanClass &&
    ("classLoader".equals(pd.getName()) || "protectionDomain".equals(pd.getName()))) {
        continue;
}
```
## 02-03 íŒ¨ì¹˜ ì „í›„ ë¹„êµ
Spring ê°œë°œìì— ì˜í•´ íŒ¨ì¹˜ê°€ ë˜ì–´ **'CachedIntrospectionResults.java'** ê°€ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.
![diff](6.png)

# ğŸ˜¾03 Exploit
#### 1. ì·¨ì•½í•œ ë„ì»¤ ì´ë¯¸ì§€ ì‹¤í–‰
```bash
docker run -d -p 8082:8080 --name springrce -it vulfocus/spring-core-rce-2022-03-29
```
![execute-docker](7.png)

#### 2. POC ì‹¤í–‰
POC ì‹¤í–‰ ì‹œ ì·¨ì•½í•œ ì„œë²„ì— ì›¹ì‰˜ì´ ìƒì„±ë©ë‹ˆë‹¤.
![execute-webshell](8.png)

POC ìš”ì²­ íŒ¨í‚·ì˜ ë§¤ê°œë³€ìˆ˜ì— 'class'ì˜ ë¡œê¹… ê´€ë ¨ ê°ì²´ê°€ ì‚¬ìš©ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
'class.module.classLoader.resources.context.parent.pipeline.first.pattern' ë§¤ê°œë³€ìˆ˜ì— ì›¹ì‰˜ì˜ ì½”ë“œë¥¼ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.
![execute-command](9.png)
#### 3. ì›¹ì‰˜ ì ‘ì† & ëª…ë ¹ì–´ ì‹¤í–‰
ì•„ë˜ URLì— ì ‘ì† ì‹œ _id_ ëª…ë ¹ì–´ê°€ ì‹¤í–‰ë˜ì–´ ê²°ê³¼ê°€ ì¶œë ¥ë©ë‹ˆë‹¤.
```http://192.168.56.105:8082/tomcatwar.jsp?pwd=j&cmd=id```
![access-webshell](10.png)
# ğŸ˜º04 Vulnerable Version
[KISA ê¶Œê³  ì‚¬í•­](https://www.krcert.or.kr/data/secNoticeView.do?bulletin_writing_sequence=66592) ì¸ìš©
> - JDK 9 ì´ìƒì˜ Spring í”„ë ˆì„ì›Œí¬ ì‚¬ìš©í•˜ëŠ” ê²½ìš°
- Spring Framework 5.3.0 ~ 5.3.17, 5.2.0 ~ 5.2.19 ë° ì´ì „ ë²„ì „
###### â€» JDK 8 ì´í•˜ì˜ ê²½ìš° ì·¨ì•½ì ì˜ ì˜í–¥ì„ ë°›ì§€ ì•ŠìŒ

#### Spring4Shell ë²„ì „ í™•ì¸ ë°©ë²•
JDK ë²„ì „ í™•ì¸: ì•„ë˜ ëª…ë ¹ ì…ë ¥
```bash
java -version
```
#### Spring í”„ë ˆì„ì›Œí¬ ì‚¬ìš© ìœ ë¬´ í™•ì¸
í”„ë¡œì íŠ¸ê°€ jar, war íŒ¨í‚¤ì§€ë¡œ ë¼ ìˆëŠ” ê²½ìš° zip í™•ì¥ìë¡œ ë³€ê²½í•˜ì—¬ ì••ì¶•í’€ê¸°
ì´í›„ ì•„ë˜ì™€ ê°™ì´ 'spring-beans-.jar', 'spring.jar', 'CachedIntrospectionResuLts.class' ë¡œ ê²€ìƒ‰
```bash
find . -name spring-beans*.jar
```
# ğŸ˜»05 Mitigation
[KISA ê¶Œê³  ì‚¬í•­](https://www.krcert.or.kr/data/secNoticeView.do?bulletin_writing_sequence=66592) ì¸ìš©

1. ì œì¡°ì‚¬ í™ˆí˜ì´ì§€ë¥¼ í†µí•´ ìµœì‹ ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸ ì ìš©
Spring Framework 5.3.18, 5.2.20 ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸ [[ë§í¬]](https://spring.io/blog/2022/03/31/spring-framework-rce-early-announcement)
â€» ì œì¡°ì‚¬ í™ˆí˜ì´ì§€ì— ì‹ ê·œë²„ì „ì´ ê³„ì† ì—…ë°ì´íŠ¸ë˜ê³  ìˆì–´ í™•ì¸ í›„ ì—…ë°ì´íŠ¸ ì ìš© í•„ìš”
2.  ì‹ ê·œ ì—…ë°ì´íŠ¸ê°€ ë¶ˆê°€ëŠ¥í•  ê²½ìš° ì•„ë˜ì™€ ê°™ì´ ì¡°ì¹˜ ì ìš©
í”„ë¡œì íŠ¸ íŒ¨í‚¤ì§€ ì•„ë˜ í•´ë‹¹ ì „ì—­ í´ë˜ìŠ¤ ìƒì„± í›„ ì¬ì»´íŒŒì¼(í…ŒìŠ¤íŠ¸ í•„ìš”)
```java
import org.springwork.core.Ordered;
import org.springwork.core.annotation.Order;
import org.springwork.web.bind.WebDataBinder;
import org.springwork.web.bind.annotation.ControllerAdvice;
import org.springwork.web.bind.annotation.InitBinder;
 
@ControllerAdvice
@Order(10000)
public class BinderControllerAdvice {
@InitBinder
public setAllowedFields(WebDataBinder dataBinder) {
String[] denylist = new String[]{"class.*", "Class.*", "*.class.*", "*.Class.*"};
dataBinder.setDisallowedFields(denylist);
}
}
```


# ğŸ“–06 References
[1] https://www.extrahop.com/company/blog/2022/a-technical-analysis-of-how-spring4shell-works/
[2] https://unit42.paloaltonetworks.com/cve-2022-22965-springshell/
[3] https://github.com/spring-projects/spring-framework/commit/002546b3e4b8d791ea6acccb81eb3168f51abb15
[4] https://github.com/lunasec-io/lunasec/blob/master/docs/blog/2022-03-30-spring-core-rce.
mdx#who-is-impacted
[6] https://www.krcert.or.kr/data/secNoticeView.do?bulletin_writing_sequence=66592
[7] https://github.com/TheGejr/SpringShell
[8] https://www.lunasec.io/docs/blog/spring-rce-vulnerabilities/